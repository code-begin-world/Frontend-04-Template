(()=>{"use strict";function t(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&e(t,n)}function e(t,n){return(e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,n)}function n(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,o=i(t);if(e){var a=i(this).constructor;n=Reflect.construct(o,arguments,a)}else n=o.apply(this,arguments);return r(this,n)}}function r(t,e){return!e||"object"!==c(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function i(t){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function a(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function s(t,e,n){return e&&a(t.prototype,e),n&&a(t,n),t}function c(t){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function u(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}var f=Symbol("state"),h=Symbol("attribute"),p=function(){function t(e){o(this,t),this[h]=Object.create(null),this[f]=Object.create(null)}return s(t,[{key:"render",value:function(){return this.root}},{key:"setAttribute",value:function(t,e){this[h][t]=e}},{key:"appendChild",value:function(t){t.mountTo(this.root)}},{key:"mountTo",value:function(t){this.root||this.render(),t.appendChild(this.root)}},{key:"triggerEvent",value:function(t,e){var n="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[h][n]&&this[h][n](new CustomEvent(t,e))}}]),t}(),d=function(e){t(i,e);var r=n(i);function i(t){var e;return o(this,i),(e=r.call(this)).root=document.createElement(t),e}return s(i,[{key:"setAttribute",value:function(t,e){this.root.setAttribute(t,e)}}]),i}(p),y=function(e){t(i,e);var r=n(i);function i(t){var e;return o(this,i),(e=r.call(this)).root=document.createTextNode(t),e}return i}(p);function v(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return m(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?m(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function b(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function g(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function w(t,e,n){return e&&g(t.prototype,e),n&&g(t,n),t}var k=function(){function t(e){b(this,t),this.element=e}return w(t,[{key:"dispatch",value:function(t,e){var n=new Event(t);if(e)for(var r in e)n[r]=e[r];this.element.dispatchEvent(n)}}]),t}(),S=function t(e,n){b(this,t);var r=!1,i=new Map;e.addEventListener("mousedown",(function(t){var e=t.button,o=Object.create(null);i.set("mouse-"+(1<<e),o),n.start(t,o);var a=function(t){for(var e=1;e<=t.buttons;){if(e&t.buttons){var r=e;2===e?r=4:4===e&&(r=2);var o=i.get("mouse-"+r);n.move(t,o)}e<<=1}};r||(document.addEventListener("mousemove",a),document.addEventListener("mouseup",(function t(e){var o="mouse-"+(1<<e.button),s=i.get(o);n.end(e,s),i.delete(o),0===e.buttons&&(document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",t),r=!1)})),r=!0)})),e.addEventListener("touchstart",(function(t){var e,r=v(t.changedTouches);try{for(r.s();!(e=r.n()).done;){var o=e.value,a=Object.create(null);i.set(o.identifier,a),n.start(o,a)}}catch(t){r.e(t)}finally{r.f()}})),e.addEventListener("touchmove",(function(t){var e,r=v(t.changedTouches);try{for(r.s();!(e=r.n()).done;){var o=e.value;n.move(o,i.get(o.identifier))}}catch(t){r.e(t)}finally{r.f()}})),e.addEventListener("touchend",(function(t){var e,r=v(t.changedTouches);try{for(r.s();!(e=r.n()).done;){var o=e.value;n.end(o,i.get(o.identifier)),i.delete(o.identifier)}}catch(t){r.e(t)}finally{r.f()}})),e.addEventListener("touchcancel",(function(t){var e,r=v(t.changedTouches);try{for(r.s();!(e=r.n()).done;){var o=e.value;n.cancel(o,i.get(o.identifier)),i.delete(o.identifier)}}catch(t){r.e(t)}finally{r.f()}}))},T=function(){function t(e){b(this,t),this.dispatcher=e}return w(t,[{key:"start",value:function(t,e){var n=this;e.startX=t.clientX,e.startY=t.clientY,this.dispatcher.dispatch("start",{clientX:t.clientX,clientY:t.clientY}),e.points=[{t:Date.now(),x:t.clientX,y:t.clientY}],e.isPan=!1,e.isTap=!0,e.isPress=!1,e.isFlick=!1,e.handler=setTimeout((function(){n.dispatcher.dispatch("press",{}),e.isTap=!1,e.isPan=!1,e.isPress=!0,e.handler=null}),500)}},{key:"move",value:function(t,e){var n=t.clientX-e.startX,r=t.clientY-e.startY;!e.isPan&&Math.pow(n,2)+Math.pow(r,2)>100&&(e.isTap=!1,e.isPan=!0,e.isPress=!1,e.isVertical=Math.abs(n)<Math.abs(r),this.dispatcher.dispatch("panstart",{startX:e.startX,startY:e.startY,clientX:t.clientX,clientY:t.clientY,isVertical:e.isVertical}),clearTimeout(e.handler)),e.isPan&&this.dispatcher.dispatch("pan",{startX:e.startX,startY:e.startY,clientX:t.clientX,clientY:t.clientY,isVertical:e.isVertical}),e.points=e.points.filter((function(t){return Date.now()-t.t<500})),e.points.push({t:Date.now(),x:t.clientX,y:t.clientY})}},{key:"end",value:function(t,e){var n;e.isTap&&(this.dispatcher.dispatch("tap",{}),clearTimeout(e.handler)),e.isPress&&this.dispatcher.dispatch("pressend",{}),e.points=e.points.filter((function(t){return Date.now()-t.t<500})),n=e.points.length?Math.sqrt(Math.pow(t.clientX-e.points[0].x,2)+Math.pow(t.clientY-e.points[0].y,2))/(Date.now()-e.points[0].t):0,console.log("move speed (px/ms):",n),n>1.5?(e.isFlick=!0,this.dispatcher.dispatch("flick",{startX:e.startX,startY:e.startY,clientX:t.clientX,clientY:t.clientY,isVertical:e.isVertical,isFlick:e.isFlick,velocity:n})):e.isFlick=!1,e.isPan&&this.dispatcher.dispatch("panend",{startX:e.startX,startY:e.startY,clientX:t.clientX,clientY:t.clientY,isVertical:e.isVertical,isFlick:e.isFlick,velocity:n}),this.dispatcher.dispatch("end",{startX:e.startX,startY:e.startY,clientX:t.clientX,clientY:t.clientY,isVertical:e.isVertical,isFlick:e.isFlick,velocity:n})}},{key:"cancel",value:function(t,e){clearTimeout(e.handler),this.dispatcher.dispatch("cancel",{})}}]),t}(),j=X(.25,.1,.25,1),A=(X(.42,0,1,1),X(0,0,.58,1));function X(t,e,n,r){var i=1e-6,o=3*t-3*n+1,a=3*n-6*t,s=3*t,c=3*e-3*r+1,u=3*r-6*e,l=3*e;function f(t){return((o*t+a)*t+s)*t}return function(t){return e=function(t){for(var e,n,r,c=t,u=0;u<8;u++){if(n=f(c)-t,Math.abs(n)<i)return c;if(e=(3*o*(r=c)+2*a)*r+s,Math.abs(e)<i)break;c-=n/e}var l=1,h=0;for(c=t;l>h;){if(n=f(c)-t,Math.abs(n)<i)return c;n>0?l=c:h=c,c=(l+h)/2}return c}(t),((c*e+u)*e+l)*e;var e}}function O(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return E(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?E(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function E(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function Y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function D(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function I(t,e,n){return e&&D(t.prototype,e),n&&D(t,n),t}X(.42,0,.58,1);var P=function(){function t(){var e=this;Y(this,t),this.animations=new Set,this.finishedAnimations=new Set,this.addTimes=new Map,this.requestID=null,this.state="inited",this.tick=function(){var t=+new Date-e.startTime;console.log("tick");var n,r=O(e.animations);try{for(r.s();!(n=r.n()).done;){var i=n.value,o=i.object,a=i.property,s=(i.template,i.start,i.end,i.duration),c=i.timeFunction,u=i.delay,l=e.addTimes.get(i);if(!(t<u+l)){var f=c((t-u-l)/s);t>s+u+l&&(f=1,e.animations.delete(i),e.finishedAnimations.add(i));var h=i.valueFromProgression(f);o[a]=h}}}catch(t){r.e(t)}finally{r.f()}e.animations.size?e.requestID=requestAnimationFrame(e.tick):e.requestID=null}}return I(t,[{key:"pause",value:function(){"playing"===this.state&&(this.state="paused",this.pauseTime=+new Date,null!==this.requestID&&(cancelAnimationFrame(this.requestID),this.requestID=null))}},{key:"resume",value:function(){"paused"===this.state&&(this.state="playing",this.startTime+=+new Date-this.pauseTime,this.tick())}},{key:"start",value:function(){"inited"===this.state&&(this.state="playing",this.startTime=+new Date,this.tick())}},{key:"reset",value:function(){"playing"===this.state&&this.pause(),this.animations=new Set,this.finishedAnimations=new Set,this.addTimes=new Map,this.requestID=null,this.startTime=+new Date,this.pauseTime=null,this.state="inited"}},{key:"restart",value:function(){"playing"===this.state&&this.pause();var t,e=O(this.finishedAnimations);try{for(e.s();!(t=e.n()).done;){var n=t.value;this.animations.add(n)}}catch(t){e.e(t)}finally{e.f()}this.finishedAnimations=new Set,this.requestID=null,this.state="playing",this.startTime=+new Date,this.pauseTime=null,this.tick()}},{key:"add",value:function(t,e){this.animations.add(t),"playing"===this.state&&null!==this.requestID&&this.tick(),"playing"===this.state?this.addTimes.set(t,void 0!==e?e:+new Date-this.startTime):this.addTimes.set(t,void 0!==e?e:0),null===this.requestID&&this.tick()}}]),t}(),x=function(){function t(e,n,r,i,o,a){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:A,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:function(t){return t};Y(this,t),this.object=e,this.property=n,this.start=r,this.end=i,this.duration=o,this.delay=a,this.timeFunction=s,this.template=c}return I(t,[{key:"valueFromProgression",value:function(t){return this.template(this.start+t*(this.end-this.start))}}]),t}();function M(t){return(M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function C(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function F(t,e){return(F=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function L(t,e){return!e||"object"!==M(e)&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function q(t){return(q=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}(function(t,e){var n;for(var r in n="string"==typeof t?new d(t):new t,e)n.setAttribute(r,e[r]);for(var i=function t(e){var r,i=u(e);try{for(i.s();!(r=i.n()).done;){var o=r.value;"object"===c(o)&&o instanceof Array?t(o):("string"==typeof o&&(o=new y(o)),n.appendChild(o))}}catch(t){i.e(t)}finally{i.f()}},o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];return i(a),n})(function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&F(t,e)}(a,t);var e,n,r,i,o=(r=a,i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=q(r);if(i){var n=q(this).constructor;t=Reflect.construct(e,arguments,n)}else t=e.apply(this,arguments);return L(this,t)});function a(){var t;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,a),(t=o.call(this))[f].position=0,t.carouselItems=[],t.handler=null,t.timeline=new P,t.template=function(t){return"translateX(".concat(t,"px)")},t.t=0,t}return e=a,(n=[{key:"render",value:function(){var t,e=this;if(this.root=document.createElement("div"),this.root.classList.add("carousel"),Array.isArray(this[h].src)){var n,r=function(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return _(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return a=t.done,t},e:function(t){s=!0,o=t},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}(this[h].src);try{for(r.s();!(n=r.n()).done;){var i=n.value,o=document.createElement("div");o.style.backgroundImage="url(".concat(i.img,")"),o.textContent=i.text,this.root.appendChild(o)}}catch(t){r.e(t)}finally{r.f()}}t=this.root,new S(t,new T(new k(t))),this.timeline.start();var a=this.root.children,s=0;return this.root.addEventListener("start",(function(t){clearInterval(e.handle),e.timeline.pause();var n=Date.now()-e.t,r=n>500||0===e.t?0:n/500;r-=Math.floor(r),s=500*-j(r)})),this.root.addEventListener("tap",(function(t){e.triggerEvent("click",{data:e[h].src[e[f].position],position:e[f].position})})),this.root.addEventListener("pan",(function(t){for(var n=e[f].position,r=t.clientX-t.startX-s,i=n-(r-r%500)/500,o=0,c=[-1,0,1];o<c.length;o++){var u=c[o],l=(i+u)%a.length;l=(l%a.length+a.length)%a.length,a[l].style.transform="translateX(".concat(500*-l+500*u+r%500,"px)")}})),this.root.addEventListener("end",(function(t){e.timeline.reset(),e.timeline.start();var n=t.clientX-t.startX-s,r=Math.sign(n%500/500),i=Math.abs(n%500/500),o=500*Math.min(i,1-i),c=e[f].position;c-=Math.round(n/500);for(var u=Math.sign(i-.5)*r,l=0,h=[0,u];l<h.length;l++){var p=h[l],d=(c+p)%a.length,y=500*(p-(d=(d%a.length+a.length)%a.length));e.timeline.add(new x(a[d].style,"transform",y+o*-u,y,500,0,j,(function(t){return"translateX(".concat(t,"px)")})))}e[f].position=c-(n-n%500)/500-r})),this.handle=setInterval((function(){var t=e[f].position,n=e.root.children,r=(t+1)%n.length,i=n[t],o=n[r];e.t=Date.now(),console.log(t,r),console.log(i,o),e.timeline.add(new x(i.style,"transform",500*-t,-500-500*t,500,0,j,(function(t){return"translateX(".concat(t,"px)")}))),e.timeline.add(new x(o.style,"transform",500-500*r,500*-r,500,0,j,(function(t){return"translateX(".concat(t,"px)")}))),e[f].position=r}),3e3),this.root}}])&&C(e.prototype,n),a}(p),{id:"div",src:[{img:"https://static001.geekbang.org/resource/image/bb/21/bb38fb7c1073eaee1755f81131f11d21.jpg",text:"1"},{img:"https://static001.geekbang.org/resource/image/1b/21/1b809d9a2bdf3ecc481322d7c9223c21.jpg",text:"2"},{img:"https://static001.geekbang.org/resource/image/b6/4f/b6d65b2f12646a9fd6b8cb2b020d754f.jpg",text:"3"},{img:"https://static001.geekbang.org/resource/image/73/e4/730ea9c393def7975deceb48b3eb6fe4.jpg",text:"4"}]}).mountTo(document.body)})();